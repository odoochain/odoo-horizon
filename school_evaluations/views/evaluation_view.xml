<?xml version="1.0" encoding="utf-8" ?>
<!--
##############################################################################
#
#    Copyright (c) 2015 be-cloud.be
#                       Jerome Sonnet <jerome.sonnet@be-cloud.be>
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU Affero General Public License as
#    published by the Free Software Foundation, either version 3 of the
#    License, or (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU Affero General Public License for more details.
#
#    You should have received a copy of the GNU Affero General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
##############################################################################
-->
<odoo>
    
    
        <!-- Top menu item -->
        <menuitem name="Evaluations" id="menu_main_evaluation" web_icon="survey,static/description/icon.png" sequence="65" groups="school_evaluations.group_evaluations,school_management.group_teacher"/>

        <!-- Partner -->
        <record id="view_partners_form_school_eval" model="ir.ui.view">
            <field name="name">view.res.partner.form.school.eval</field>
            <field name="model">res.partner</field>
            <field name="inherit_id" ref="school_management.view_partners_form_school" />
            <field eval="18" name="priority" />
            <field name="arch" type="xml">
                <xpath expr="//field[@name='total_credits']" position="after">
                    <field name="state"/>
                </xpath>
            </field>
        </record>

        <record id="view_individual_program_eval_filter" model="ir.ui.view">
            <field name="name">school.individual_program.eval.filter</field>
            <field name="model">school.individual_program</field>
            <field name="inherit_id" ref="school_management.view_individual_program_filter" />
            <field eval="25" name="priority" />
            <field name="arch" type="xml">
                <xpath expr="//field[@name='student_id']" position="after">
                    <separator/>
                    <field name="grade_year_id"/>
                    <filter name="program_completed" string="Completed" domain="[('program_completed', '=', True)]"/>
                    <separator/>
                    <filter name="draft" string="Draft" domain="[('state', 'in', ['draft'])]" />
                    <filter name="progress" string="Progress" domain="[('state', 'in', ['progress'])]" />
                    <filter name="awarded" string="Awarded" domain="[('state', 'in', ['awarded'])]" />
                    <filter name="abandoned" string="Abandonned" domain="[('state', 'in', ['abandoned'])]" />
                </xpath>
            </field>
        </record>
    
        <template id="assets_common" inherit_id="web.assets_common" name="Horizon Evaluations Assets">
            <xpath expr="." position="inside">
                <link rel="stylesheet" type="text/css" href="/school_evaluations/static/src/css/school_evaluations.css"/>
            </xpath>
        </template>
    
        <!-- Add evaluation to Individual Program form view -->
        <record id="individual_program_eval_form" model="ir.ui.view">
            <field name="name">school.individual_program.eval.view</field>
            <field name="model">school.individual_program</field>
            <field name="inherit_id" ref="school_management.individual_program_form" />
            <field eval="25" name="priority" />
            <field name="arch" type="xml">
                <xpath expr="//sheet" position="before">
                    <header>
                        <button name="set_to_progress" type="object" states="draft" string="Progress" class="oe_highlight" />
                        <button name="set_to_awarded" type="object" states="progress" string="Awarded" class="oe_highlight" />
                        <button name="set_to_abandonned" type="object" states="progress" string="Abandoned" class="oe_highlight" />
                        <button name="set_to_draft" type="object" states="progress,awarded,abandoned" string="Reset to Draft" />
                        <field name="state" widget="statusbar" statusbar_visible=" " />
                    </header>
                </xpath>
                <!--<xpath expr="//field[@name='image']" position="before">
                    <div class="oe_button_box" name="button_box">
                            <button name="toggle_active" type="object"
                                    class="oe_stat_button" icon="fa-archive">
                                <field name="active" widget="boolean_button"
                                    options='{"terminology": "archive"}'/>
                            </button>
                    </div>
                </xpath>-->
                <xpath expr="//field[@name='required_credits']" position="after">         
                    <field name="total_registered_credits" />
                    <field name="total_acquiered_credits" />
                    <field name="evaluation" />
                    <field name="grade" />
                    <field name="grade_year_id" />
                    <newline/>
                    <field name="grade_comments" colspan="4"/>
                </xpath>
                <xpath expr="//field[@name='bloc_ids']/kanban/field[@name='total_credits']" position="after">
                    <field name="evaluation"/>
                    <field name="state"/>
                    <field name="decision"/>
                </xpath>
                <xpath expr="//field[@name='bloc_ids']//div[@class='oe_module_vignette']" position="replace">
                    <div class="oe_module_vignette">
                      <div class="row mb-2">
                        <div class="col-6">
                          <h5><field name="uid" /></h5>
                        </div>
                        <div class="col-6 text-right">
                          <field name="year_id"/>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-6">
                            Acquis : <field name="total_acquiered_credits" /> ECTS
                        </div>
                        <div class="col-6">
                            Total : <field name="total_credits"/> ECTS
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-6">
                          Heures : <field name="total_hours"/>
                        </div>
                        <div class="col-6">
                            Moyenne : <field name="evaluation"/>
                        </div>
                      </div>
                      <div class="row mb-2" style="min-height: 45px;">
                         <div class="col-12">
                           Decision : <field name="decision"/>
                         </div>
                      </div>
                      <div class="row">
                        <div class="col-8">
                        </div>
                        <div class="col-4">
                            <button type="object" name="action_open_form" class="oe_highlight btn btn-primary">Open</button>
                        </div>
                      </div>
                    </div>
                </xpath>
                <xpath expr="//field[@name='course_group_summaries']/kanban/field[@name='total_credits']" position="after">
                    <field name="state"/>
                    <field name="trials"/>
                    <field name="final_result_disp"/>
                </xpath>
                <xpath expr="//div[contains(@t-attf-class, 'horizon_cgs')]" position="attributes">
                    <attribute name="t-attf-class">horizon_cgs horizon_cgs_{{record.state.raw_value}}</attribute>
                </xpath>
                <xpath expr="//div[contains(@class, 'horizon_cgs_evals')]" position="inside">
                    <div class="row">
                        Unité suivie à <field name="trials" class="oe_inline"/> reprise(s).
                    </div>
                    <div class="row">
                        Dernière évaluation de <field name="final_result_disp" class="oe_inline"/>.
                    </div>
                </xpath>
            </field>
        </record>
        
        <!-- Add evaluation to Individual Course tree view -->
        <record id="individual_program_eval_tree" model="ir.ui.view">
            <field name="name">school.individual_program.eval.tree</field>
            <field name="model">school.individual_program</field>
            <field name="inherit_id" ref="school_management.view_individual_program_tree" />
            <field eval="25" name="priority" />
            <field name="arch" type="xml">
                <xpath expr="//field[@name='required_credits']" position="after">
                    <field name="total_registered_credits" />
                    <field name="total_acquiered_credits" />
                    <field name="grade"/>
                    <field name="grade_year_id"/>
                    <field name="state"/>
                </xpath>
            </field>
        </record>
        
        <record id="view_individual_bloc_filter_eval" model="ir.ui.view">
            <field name="name">individual_bloc.select.eval</field>
            <field name="model">school.individual_bloc</field>
            <field name="inherit_id" ref="school_management.view_individual_bloc_filter" />
            <field name="arch" type="xml">
                <xpath expr="//group" position="before">
                    <separator/>
                    <filter name="draft" string="Draft" domain="[('state', 'in', ['draft'])]" />
                    <filter name="awarded" string="Awarded" domain="[('state', 'in', ['awarded_first_session','awarded_second_session'])]" />
                    <filter name="postponed" string="Postponed" domain="[('state', 'in', ['postponed'])]" />
                </xpath>
            </field>
        </record>

        <!-- Add evaluation to Individual Bloc form view -->
        <record id="individual_bloc_eval_form" model="ir.ui.view">
            <field name="name">school.individual_bloc.eval.view</field>
            <field name="model">school.individual_bloc</field>
            <field name="inherit_id" ref="school_management.individual_bloc_form" />
            <field eval="25" name="priority" />
            <field name="arch" type="xml">
                <xpath expr="//sheet" position="before">
                    <header>
                        <button name="report_send" string="Email Report" type="object" icon="fa-envelope"
                                context="{'default_composition_mode':'comment', 'default_template_id': 1}" states="progress,postponed,awarded_first_session,awarded_second_session,failed"/>
                        <button name="set_to_progress" type="object" states="draft" string="Progress" class="oe_highlight" />
                        <button name="set_to_postponed" type="object" states="progress" string="Postpone" class="oe_highlight" />
                        <button name="set_to_awarded_first_session" type="object" states="progress" string="Awarded" class="oe_highlight" />
                        <button name="set_to_awarded_second_session" type="object" states="postponed" string="Awarded" class="oe_highlight" />
                        <button name="set_to_failed" type="object" states="progress,postponed" string="Failed" class="oe_highlight" />
                        <button name="set_to_draft" type="object" states="progress,postponed,awarded_first_session,awarded_second_session,failed,abandoned" string="Reset to Draft" />
                        <button name="set_to_abandoned" type="object" states="draft,progress,postponed" string="Abandon" />
                        <field name="state" widget="statusbar" states="draft,progress" statusbar_visible="draft,progress,postponed,awarded_first_session,failed,abandoned" />
                        <field name="state" widget="statusbar" states="postponed" statusbar_visible="draft,postponed,awarded_second_session,failed,abandoned" />
                        <field name="state" widget="statusbar" states="awarded_first_session,awarded_second_session,failed,abandoned" statusbar_visible="awarded_first_session,awarded_second_session,failed,abandoned" />
                    </header>
                </xpath>
                <xpath expr="//field[@name='total_credits']" position="after">
                    <newline/>
                    <field name="total_acquiered_credits"/>
                    <field name="total_credits"/>
                    <field name="evaluation"/>
                    <field name="exclude_from_deliberation" string="Exc Delib"/>
                    <field name="decision" colspan="4"/>
                </xpath>
                <xpath expr="//field[@name='source_course_group_id']" position="before">
                    <field name="first_session_result" string="S1" />
                    <field name="second_session_result" string="S2" />
                    <field name="final_result" string="Fin" />
                    <field name="acquiered" string="Acq" />
                    <field name="state"/>
                    <button type="object" icon="fa-archive" name="valuate_course_group" string="Valuate Course Group" attrs="{'invisible': [('state', '!=', ('draft'))]}"/>
                </xpath>
            </field>
        </record>

        <!-- Add evaluation to Individual Course tree view -->
        <record id="individual_bloc_eval_tree" model="ir.ui.view">
            <field name="name">school.individual_bloc.eval.tree</field>
            <field name="model">school.individual_bloc</field>
            <field name="inherit_id" ref="school_management.view_individual_bloc_tree" />
            <field eval="25" name="priority" />
            <field name="arch" type="xml">
                <xpath expr="//field[@name='total_credits']" position="after">
                    <field name="total_acquiered_credits" />
                    <field name="state"/>
                </xpath>
            </field>
        </record>

        <!-- Add evaluation to Individual Course Group form view -->
        <record id="course_group_eval_form" model="ir.ui.view">
            <field name="name">school.course_group.eval.view</field>
            <field name="model">school.course_group</field>
            <field name="inherit_id" ref="school_management.course_group_form" />
            <field eval="25" name="priority" />
            <field name="arch" type="xml">
                <xpath expr="//field[@name='total_weight']" position="after">
                    <field name="enable_exclusion_bool"/>
                </xpath>
            </field>
        </record>

        <!-- Add evaluation to Individual Course tree view -->
        <record id="individual_course_group_eval_tree" model="ir.ui.view">
            <field name="name">school.individual_course_group.eval.tree</field>
            <field name="model">school.individual_course_group</field>
            <field name="inherit_id" ref="school_management.view_individual_course_group_tree" />
            <field eval="25" name="priority" />
            <field name="arch" type="xml">
                <xpath expr="//field[@name='name']" position="after">
                    <field name="final_result" string="Res"/>
                    <field name="acquiered" string="Acq" readonly="1" />
                    <field name="state"/>
                    <button type="object" icon="fa-archive" name="valuate_course_group" string="Valuate Course Group" attrs="{'invisible': [('state', '!=', ('draft'))]}"/>
                </xpath>
            </field>
        </record>

        <!-- Add evaluation to Individual Course Group form view -->
        <record id="individual_course_group_eval_form" model="ir.ui.view">
            <field name="name">school.individual_course_group.eval.view</field>
            <field name="model">school.individual_course_group</field>
            <field name="inherit_id" ref="school_management.individual_course_group_form" />
            <field eval="25" name="priority" />
            <field name="arch" type="xml">
                <xpath expr="//sheet" position="before">
                    <header>
                        <button name="set_to_valuated" type="object" states="candidate" string="Confirm valuation" class="oe_highlight" />
                        <button name="set_to_confirmed" type="object" states="progress" string="Confirm evaluation" class="oe_highlight" />
                        <field name="state" widget="statusbar" statusbar_visible="draft,progress,candidate,confirmed,success, failure, valuated" />
                    </header>
                </xpath>
                <xpath expr="//field[@name='source_course_id']" position="before">
                    <field name="first_session_result" string="S1" />
                    <field name="second_session_result" string="S2" />
                </xpath>
                <xpath expr="//field[@name='total_credits']" position="after">
                    <group col="2" colspan="2" string="First Session">
                        <field name="first_session_computed_result_bool" invisible="1" />
                        <field name="first_session_computed_result" widget="statinfo" string="Result" />
                        <field name="first_session_computed_result_bool" string="Result Bool" groups="base.group_configuration"/>
                        <field name="first_session_deliberated_result_bool" string="Deliberated" />
                        <field name="first_session_deliberated_result" attrs="{'readonly':[('first_session_deliberated_result_bool','==',False)]}" string="Deliberated Result" />
                        <field name="first_session_result" widget="statinfo" string="Session Result" />
                        <field name="first_session_result_bool" string="Session Result Bool" groups="base.group_configuration"/>
                        <field name="first_session_result_bool" invisible="1" />
                    </group>
                    <group col="2" colspan="2" string="Second Session">
                        <field name="second_session_computed_result_bool" invisible="1" />
                        <field name="second_session_computed_result" widget="statinfo" string="Result" />
                        <field name="second_session_computed_result_bool" string="Result Bool" groups="base.group_configuration"/>
                        <field name="second_session_deliberated_result_bool" string="Deliberated" />
                        <field name="second_session_deliberated_result" attrs="{'readonly':[('second_session_deliberated_result_bool','==',False)]}" string="Deliberated Result" />
                        <field name="second_session_result" widget="statinfo" string="Session Result" />
                        <field name="second_session_result_bool" string="Session Result Bool" groups="base.group_configuration"/>
                        <field name="second_session_result_bool" invisible="1" />
                    </group>
                    <separator string="Final Results" colspan="4" />
                    <field name="final_result" widget="statinfo" />
                    <field name="acquiered" />
                    <field name="final_result_bool" invisible="1" />
                    <newline/>
                </xpath>
                <xpath expr="//field[@name='total_credits']/parent::group" position="after">
                    <field name="final_note" colspan="4" placeholder="Justify the final evaluation here." />
                </xpath>
            </field>
        </record>

        <!-- Add evaluation to Individual Course form view -->
        <record id="individual_course_eval_form" model="ir.ui.view">
            <field name="name">school.individual_course.eval.view</field>
            <field name="model">school.individual_course</field>
            <field name="inherit_id" ref="school_management.view_individual_course_form" />
            <field eval="25" name="priority" />
            <field name="arch" type="xml">
                <xpath expr="//sheet" position="inside">
                    <notebook>
                        <page string="Results">
                            <group col="2" string="Results">
                                <field name="partial_result" attrs="{'readonly': [('is_annual','=',False)]}" />
                                <field name="final_result" />
                                <field name="second_result" />
                                <field name="is_annual" invisible="1" />
                                <field name="is_danger" invisible="1" />
                            </group>
                        </page>
                        <page string="Archive">
                            <group col="4" string="Results">
                                <field name="jun_result" />
                                <field name="sept_result" />
                            </group>
                            <group col="4">
                                <group col="2" colspan="2" string="First Session">
                                    <field name="first_session_result_bool" invisible="1" />
                                    <div class="col-md-5">
                                        <h1>
                                            <field name="first_session_result" attrs="{'invisible':[('first_session_result_bool','==',False)]}"  nolabel="1" class="label label-primary" readonly="1" style="padding:.2em .6em .3em;"/>
                                        </h1>
                                    </div>
                                    <field name="first_session_note" colspan="2" nolabel="1" placeholder="Justify the evaluation here." />
                                </group>
                                <group col="2" colspan="2" string="Second Session">
                                    <field name="second_session_result_bool" invisible="1" />
                                    <div class="col-md-5">
                                        <h1>
                                            <field name="second_session_result" attrs="{'invisible':[('second_session_result_bool','==',False)]}"  nolabel="1" class="label label-primary" readonly="1" style="padding:.2em .6em .3em;"/>
                                        </h1>
                                    </div>
                                    <field name="second_session_note" colspan="2" nolabel="1" placeholder="Justify the evaluation here." />
                                </group>
                            </group>
                        </page>
                    </notebook>
                </xpath>
            </field>
        </record>

        <!-- Add evaluation to Individual Course form view -->
        <record id="individual_course_eval_tree" model="ir.ui.view">
            <field name="name">school.individual_course.eval.tree</field>
            <field name="model">school.individual_course</field>
            <field name="inherit_id" ref="school_management.view_individual_course_tree" />
            <field eval="25" name="priority" />
            <field name="arch" type="xml">
                <xpath expr='//tree' position="attributes">
                    <attribute name="decoration-muted">not first_session_result_bool</attribute>
                    <attribute name="decoration-danger">is_danger</attribute>
                </xpath>
                <xpath expr="//field[@name='name']" position="after">
                    <field name="partial_result" string="Par" class="horizon_eval_cell" attrs="{'readonly': [('is_annual','=',False)]}" />
                    <field name="final_result" string="Fin" class="horizon_eval_cell" /> <!-- readonly="1" /> -->
                    <field name="first_session_result" string="S1" invisible="1" />
                    <field name="second_result" string="Sec" class="horizon_eval_cell" /> <!-- readonly="1" /> -->
                    <field name="second_session_result" string="S2" invisible="1" />
                    <field name="first_session_result_bool" invisible="1" />
                    <field name="second_session_result_bool" invisible="1" />
                    <field name="is_annual" invisible="1" />
                    <field name="is_danger" invisible="1" />
                </xpath>
            </field>
        </record>
        
        <!-- Add evaluation to Individual Course tree view - ->
        <record id="individual_course_eval_tree_security" model="ir.ui.view">
            <field name="name">school.individual_course.eval.tree.sec</field>
            <field name="model">school.individual_course</field>
            <field name="inherit_id" ref="individual_course_eval_tree" />
            <field eval="25" name="priority" />
            <field name="groups_id" eval="[(6, 0, [ref('school_evaluations.group_evaluations') ])]" />
            <field name="arch" type="xml">
                <xpath expr="//field[@name='dispense']" position="replace">
                    <field name="dispense" string="Dis" />
                </xpath>
                <xpath expr="//field[@name='type']" position="replace">
                    <field name="type" />
                </xpath>
                <xpath expr="//field[@name='ann_result']" position="replace">
                    <field name="ann_result" string="Ann" attrs="{'readonly': [('type','in',['S','T','D'])]}" />
                </xpath>
                <xpath expr="//field[@name='jan_result']" position="replace">
                    <field name="jan_result" string="Jan" attrs="{'readonly': [('type','in',['S','D'])]}" />
                </xpath>
                <xpath expr="//field[@name='jun_result']" position="replace">
                    <field name="jun_result" string="June"/>
                </xpath>
                <xpath expr="//field[@name='sept_result']" position="replace">
                    <field name="sept_result" string="Sept" attrs="{'readonly': [('type','in',['D'])]}" />
                </xpath>
            </field>
        </record>
        
        <!- - Add evaluation to Individual Course form view - ->
        <record id="individual_course_eval_tree_security_teacher" model="ir.ui.view">
            <field name="name">school.individual_course.eval.tree.sec</field>
            <field name="model">school.individual_course</field>
            <field name="inherit_id" ref="individual_course_eval_tree" />
            <field eval="25" name="priority" />
            <field name="groups_id" eval="[(6, 0, [ref('school_management.group_teacher') ])]" />
            <field name="arch" type="xml">
                <xpath expr="//field[@name='ann_result']" position="replace">
                    <field name="ann_result" string="Ann" attrs="{'readonly': [('type','in',['S','T','D'])]}" />
                </xpath>
                <xpath expr="//field[@name='jan_result']" position="replace">
                    <field name="jan_result" string="Jan" attrs="{'readonly': [('type','in',['S','D'])]}" />
                </xpath>
                <xpath expr="//field[@name='jun_result']" position="replace">
                    <field name="jun_result" string="June"/>
                </xpath>
                <xpath expr="//field[@name='sept_result']" position="replace">
                    <field name="sept_result" string="Sept" attrs="{'readonly': [('type','in',['D'])]}" />
                </xpath>
            </field>
        </record> -->

        <record id="view_individual_courses_filter_eval" model="ir.ui.view">
            <field name="name">individual_course.select.eval</field>
            <field name="model">school.individual_course</field>
            <field name="inherit_id" ref="school_management.view_individual_courses_filter" />
            <field name="arch" type="xml">
                <xpath expr="//filter[@name='previous']" position="after">
                    <separator/>
                    <filter name="no_res_s1" string="No result for S1" domain="[('first_session_result_bool', '=', False)]" />
                    <filter name="no_res_s2" string="No result for S2" domain="[('second_session_result_bool', '=', False)]" />
                </xpath>
            </field>
        </record>

        <record id="action_individual_course_form" model="ir.actions.act_window">
          <field name="name">Encodage Résultats AA</field>
          <field name="type">ir.actions.act_window</field>
          <field name="res_model">school.individual_course</field>
          
          <field name="view_mode">tree,form</field>
          <field name="context">{"search_default_current":1}</field>
          <field name="search_view_id" ref="school_management.view_individual_courses_filter" />
          <field name="help" type="html">
            <p class="oe_view_nocontent_create">
              Please add individual program from Student view.
            </p>
          </field>
        </record>
    
        <record id="action_individual_course_form_teacher" model="ir.actions.act_window">
          <field name="name">Encodage Résultats AA</field>
          <field name="type">ir.actions.act_window</field>
          <field name="res_model">school.individual_course</field>
          
          <field name="view_mode">tree,form</field>
          <field name="context">{"search_default_my_current_courses":1}</field>
          <field name="search_view_id" ref="school_management.view_individual_courses_filter" />
          <field name="help" type="html">
            <p class="oe_view_nocontent_create">
              Please add individual program from Student view.
            </p>
          </field>
        </record>

        <menuitem id="menu_individual_course_form" parent="menu_main_evaluation" action="action_individual_course_form" sequence="20" groups="school_evaluations.group_evaluations"/>
        
        <menuitem id="menu_individual_course_form_teacher" parent="menu_main_evaluation" action="action_individual_course_form_teacher" sequence="40" groups="school_management.group_teacher"/>
        
        <menuitem name="Evaluations" id="menu_main_evaluation" web_icon="survey,static/description/icon.png" sequence="65" groups="school_evaluations.group_evaluations,school_management.group_teacher"/>

</odoo>